// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum Role {
  ADMIN
  USER
}

enum EnrollmentStatus {
  ACTIVE      // Plan activo
  EXPIRING    // Por vencer (7 días antes)
  EXPIRED     // Vencido
}

enum MediaType {
  INITIAL_PHOTO   // Foto inicial (pesaje)
  DAY_1_VIDEO     // Video día 1
  FINAL_VIDEO     // Video último día
}

enum DocumentType {
  DIET        // PDF de dieta
  ROUTINE     // PDF de rutina  
  TRAINING    // PDF de entrenamiento
  REPORT      // Informe general como imagen (jpg/png)
  IMAGE       // Imagenes generales
}

// USER & AUTHENTICATION

model User {
  id        String   @id @default(cuid())
  email     String?  @unique    // Opcional - puede usar solo username
  username  String   @unique
  passwordHash  String   // Hashed with bcrypt
  phone     String?  // Teléfono (opcional)
  name      String
  role      Role     @default(USER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  enrollments      Enrollment[]
  trainerComments  TrainerComment[]
  accounts         Account[]
  sessions         Session[]
  favoriteExercises FavoriteExercise[]
  userVideos       UserVideo[]
  documents        Document[]
  
  @@index([email])
  @@index([username])
  @@map("users")
}

// NextAuth.js Models

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

// PLANS (Public - hasta 5 planes)

model Plan {
  id          String   @id @default(cuid())
  name        String   // "RETO FITNESS 2da EDICIÓN", "Plan Básico", etc.
  description String   @db.Text
  durationDays    Int      // Duración en días (ej: 84 para 12 semanas)
  price       Decimal  @db.Decimal(10, 2)
  features    String[] // Array de características incluidas
  isActive    Boolean  @default(true) // Para mostrar/ocultar en público
  order       Int      @default(0) // Orden de visualización
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  enrollments Enrollment[]
  
  @@index([isActive, order])
  @@map("plans")
}

// ENROLLMENT (Ciclo de plan por usuario)

model Enrollment {
  id          String           @id @default(cuid())
  userId      String
  planId      String
  
  // Fechas del ciclo
  startDate   DateTime
  endDate     DateTime
  status      EnrollmentStatus @default(ACTIVE)
  
  // Tracking
  daysRemaining Int?           // Calculado o actualizado
  notified7Days Boolean        @default(false) // Si ya se notificó 7 días antes
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            Plan              @relation(fields: [planId], references: [id])
  progress        Progress[]
  media           Media[]
  documents       Document[]
  trainerComments TrainerComment[]
  exerciseLogs    ExerciseLog[]
  
  @@index([userId, status])
  @@index([status, endDate])
  @@map("enrollments")
}

// PROGRESS (Cada 15 días)

model Progress {
  id           String   @id @default(cuid())
  enrollmentId String
  
  // Datos de progreso
  dayNumber    Int      // Día 1, 15, 30, 45, etc.
  weight       Decimal? @db.Decimal(5, 2) // Peso en kg
  bodyFat      Decimal? @db.Decimal(5, 2) // Porcentaje de grasa corporal
  muscleMass   Decimal? @db.Decimal(5, 2) // Masa muscular
  measurements Json?    // Medidas: pecho, cintura, cadera, brazos, etc.
  notes        String?  @db.Text
  
  recordDate   DateTime @default(now())
  createdAt    DateTime @default(now())
  
  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@unique([enrollmentId, dayNumber]) // Solo un registro por día específico
  @@index([enrollmentId, dayNumber])
  @@map("progress")
}

// MEDIA (Fotos y Videos)

model Media {
  id           String    @id @default(cuid())
  enrollmentId String
  
  type         MediaType
  filename     String    // Nombre del archivo
  url          String    // Ruta relativa o URL
  fileSize     Int?      // Tamaño en bytes
  mimeType     String?   // image/jpeg, video/mp4, etc.
  
  uploadedAt   DateTime  @default(now())
  
  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  
  @@index([enrollmentId, type])
  @@map("media")
}

// DOCUMENTS (PDFs de dieta y rutina)

model Document {
  id           String       @id @default(cuid())
  enrollmentId String?      // Opcional - para compatibilidad
  userId       String?      // Usuario al que pertenece el documento (nullable para migración)
  
  type         DocumentType
  fileName     String?      // Nombre del archivo (nullable para migración)
  filename     String?      // Campo legacy (mantener por compatibilidad)
  filePath     String?      // Ruta del archivo en el servidor (nullable para migración)  
  url          String?      // Campo legacy (mantener por compatibilidad)
  fileSize     Int?         // Tamaño en bytes
  description  String?      @db.Text
  isActive     Boolean      @default(true) // Para ocultar documentos sin eliminarlos
  
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  uploadedAt   DateTime?    // Campo legacy
  
  // Relations
  enrollment   Enrollment?  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([enrollmentId, type])
  @@index([userId, type])
  @@map("documents")
}

// TRAINER COMMENTS (Comentarios del entrenador)

model TrainerComment {
  id           String   @id @default(cuid())
  enrollmentId String
  userId       String?   // El admin que escribió el comentario (opcional)
  
  comment      String   @db.Text
  isVisible    Boolean  @default(true) // Si el usuario puede verlo
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  author       User?      @relation(fields: [userId], references: [id])
  
  @@index([enrollmentId, createdAt])
  @@map("trainer_comments")
}

// EXERCISES (Catálogo - Opción B para futuro)

model Exercise {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  imagePath   String?  // Ruta a imagen demostrativa
  category    String?  // "Pecho", "Espalda", "Piernas", etc.
  difficulty  String?  // "Principiante", "Intermedio", "Avanzado"
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  exerciseLogs ExerciseLog[]
  
  @@index([category, isActive])
  @@map("exercises")
}

// EXERCISE LOGS (Registro de ejercicios realizados)

model ExerciseLog {
  id           String   @id @default(cuid())
  enrollmentId String
  exerciseId   String?  // Opcional si no usa catálogo
  
  // Datos del ejercicio
  exerciseName String   // Nombre del ejercicio (manual o del catálogo)
  sets         Int?     // Número de series
  reps         Int?     // Repeticiones
  weight       Decimal? @db.Decimal(6, 2) // Peso usado (kg o lbs)
  notes        String?  @db.Text
  completed    Boolean  @default(false)
  
  // Fecha de realización
  logDate  DateTime @default(now())
  createdAt    DateTime @default(now())
  
  // Relations
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  exercise     Exercise?  @relation(fields: [exerciseId], references: [id])
  
  @@index([enrollmentId, logDate])
  @@index([exerciseId])
  @@map("exercise_logs")
}

// FAVORITE EXERCISES (Ejercicios favoritos del usuario - de Gym API)

model FavoriteExercise {
  id             String   @id @default(cuid())
  userId         String
  
  // Datos del ejercicio de la Gym API
  exerciseApiId  String   // ID del ejercicio en la Gym API
  exerciseName   String   // Nombre en inglés
  exerciseNameEs String?  // Nombre en español
  bodyPart       String   // Parte del cuerpo
  bodyPartEs     String?  // Traducido
  equipment      String   // Equipo necesario
  equipmentEs    String?  // Traducido
  target         String   // Músculo objetivo
  targetEs       String?  // Traducido
  gifUrl         String?  // URL del GIF
  
  createdAt      DateTime @default(now())
  
  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  progressLogs   FavoriteExerciseProgress[]
  
  @@unique([userId, exerciseApiId]) // Un usuario solo puede tener un ejercicio favorito por ID
  @@index([userId])
  @@map("favorite_exercises")
}

// FAVORITE EXERCISE PROGRESS (Progreso en ejercicios favoritos)

model FavoriteExerciseProgress {
  id                 String   @id @default(cuid())
  favoriteExerciseId String
  
  // Datos del progreso
  sets               Int      // Número de series
  reps               Int      // Repeticiones
  weight             Decimal? @db.Decimal(6, 2) // Peso en kg
  duration           Int?     // Duración en segundos (para cardio)
  notes              String?  @db.Text
  
  logDate            DateTime @default(now())
  createdAt          DateTime @default(now())
  
  // Relations
  favoriteExercise   FavoriteExercise @relation(fields: [favoriteExerciseId], references: [id], onDelete: Cascade)
  
  @@index([favoriteExerciseId, logDate])
  @@map("favorite_exercise_progress")
}

// USER VIDEOS (Videos subidos por usuarios)

model UserVideo {
  id          String   @id @default(cuid())
  userId      String
  
  // Datos del video
  fileName    String   // Nombre original del archivo
  filePath    String   // Ruta del archivo en el servidor
  fileSize    Int      // Tamaño en bytes
  mimeType    String   // video/mp4, video/avi, etc.
  duration    Int?     // Duración en segundos (opcional)
  
  // Metadatos
  title       String?  // Título personalizado
  description String?  @db.Text // Descripción del video
  isVisible   Boolean  @default(true) // Si el video es visible para el entrenador
  
  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, uploadedAt])
  @@map("user_videos")
}
